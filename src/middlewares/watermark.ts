/**
 * @Description: 图片水印中间件
 * @Author: daixu
 * @Date: 2023-11-28 17:19:09
 */
import { Context, Next } from "koa";
import { COPYRIGHT, ASSET_DIR } from "@/config/env";
import stream from "stream";
import sharp from "sharp";
import imageSize from "image-size";

// 生成 SVG 水印
const generateSVG = (width: number, height: number) => {
  return `<svg t="1701243577839" class="icon" viewBox="0 0 1029 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3225" width="${width}" height="${height}"><path d="M77.174634 579.750504c-4.329106 8.491707-8.741463 13.653333-13.237073 15.484878-4.49561 1.831545-6.909919 2.497561-7.242927 1.998049-5.32813-0.166504-9.40748-2.497561-12.238049-6.993171-2.830569-4.662114-4.91187-10.073496-6.243902-16.234146-1.165528-6.16065-1.831545-11.48878-1.998049-15.98439-0.166504-4.662114-0.166504-7.159675 0-7.492683 0.333008-22.478049 3.746341-36.131382 10.24-40.96 6.493659-4.995122 10.24-6.993171 11.239025-5.994147 5.827642 1.165528 10.489756 3.996098 13.986341 8.491708 3.496585 4.329106 5.32813 6.743415 5.494634 7.242926v60.440976z m49.701464 17.482927c-7.159675-0.499512-11.48878-2.830569-12.987318-6.993171-1.332033-4.329106-1.831545-6.826667-1.498536-7.492683v-143.609756H58.692683v5.994146c8.824715 0.666016 14.152846 3.163577 15.98439 7.492683 1.998049 4.329106 2.830569 6.660163 2.497561 6.993171v45.955122c-3.163577-5.161626-7.575935-8.99122-13.237073-11.48878-5.661138-2.664065-10.989268-3.996098-15.98439-3.996098-15.817886 0.666016-27.806179 7.492683-35.964878 20.48-7.992195 12.820813-11.988293 27.389919-11.988293 43.707317 0.83252 21.146016 6.16065 35.798374 15.98439 43.957073 9.82374 8.158699 19.147967 12.071545 27.972683 11.738537 9.490732 0 16.567154-1.332033 21.229268-3.996098 4.828618-2.830569 8.824715-6.576911 11.988293-11.239024v14.236097c6.826667-0.499512 14.069593-1.165528 21.728781-1.998048 7.659187-0.83252 11.821789-1.332033 12.487805-1.498537 2.997073-0.166504 6.243902-0.499512 9.740487-0.999024 3.496585-0.666016 5.411382-1.082276 5.744391-1.248781v-5.994146zM288.609821 594.486114c-4.49561 2.497561-7.409431 0.83252-8.741463-4.995122v-65.436098c-1.332033-15.318374-8.158699-24.892358-20.48-28.721951-12.154797-3.996098-21.978537-5.74439-29.47122-5.244878-21.146016 1.165528-34.466341 6.327154-39.960975 15.484878-5.32813 9.157724-7.575935 14.402602-6.743415 15.734634 0.666016 7.825691 3.330081 12.654309 7.992195 14.485854 4.828618 1.831545 7.659187 2.497561 8.491707 1.998049 6.660163-0.166504 11.155772-1.748293 13.48683-4.745366 2.331057-3.163577 3.413333-6.16065 3.246829-8.99122-0.333008-2.331057-1.24878-4.662114-2.747317-6.99317-1.332033-2.331057-2.081301-3.579837-2.247805-3.746342-1.665041-4.162602-2.331057-6.410407-1.998049-6.743415 0.999024-3.663089 3.663089-5.994146 7.992195-6.99317 4.329106-1.165528 7.409431-1.748293 9.240976-1.748293 9.324228 0.999024 14.902114 4.828618 16.733658 11.488781 1.831545 6.493659 2.580813 10.156748 2.247805 10.989268v17.482927c-33.633821 10.489756-53.697561 20.813008-60.191219 30.969756-6.327154 9.990244-8.741463 15.235122-7.242927 15.734634 0.666016 11.48878 4.329106 18.731707 10.989268 21.72878 6.826667 2.830569 12.654309 4.07935 17.482927 3.746342 10.822764-0.666016 19.897236-3.246829 27.223415-7.742439 7.492683-4.662114 11.405528-7.242927 11.738536-7.742439 1.665041 7.326179 5.411382 11.821789 11.239025 13.486829 5.994146 1.665041 9.40748 2.331057 10.24 1.998049 7.492683-0.83252 13.819837-2.997073 18.981463-6.493659 5.161626-3.663089 7.908943-5.74439 8.241951-6.243902l-3.746341-4.745366z m-42.958049-11.738537c-1.165528 1.165528-1.831545 1.748293-1.998048 1.748293-9.490732 7.326179-14.652358 10.323252-15.484878 8.991219-6.16065-0.666016-9.906992-3.413333-11.239025-8.241951-1.332033-4.828618-1.831545-7.659187-1.498536-8.491707 1.165528-9.990244 6.16065-17.482927 14.985365-22.478049 8.824715-5.161626 13.903089-7.742439 15.235122-7.742439v36.214634zM359.865236 449.877333c0.499512 13.320325 6.909919 20.146992 19.231219 20.48 12.987317-1.165528 19.64748-7.825691 19.980488-19.980487-0.999024-13.819837-7.575935-20.646504-19.730732-20.48-12.654309 1.665041-19.147967 8.325203-19.480975 19.980487z m48.952195 154.848781c-5.827642-0.499512-9.324228-2.997073-10.489756-7.492683-1.165528-4.49561-1.581789-7.076423-1.248781-7.742439v-99.402927h-47.95317v5.74439c6.493659 0.83252 10.406504 3.579837 11.738536 8.241952 1.498537 4.662114 2.164553 7.242927 1.998049 7.742439v76.675121c-0.666016 7.825691-2.997073 12.571057-6.993171 14.236098-3.996098 1.665041-6.243902 2.331057-6.743414 1.998049v5.74439h59.691707v-5.74439zM508.445138 566.013919c3.829593 6.327154 7.742439 12.904065 11.738537 19.730731 4.162602 6.660163 6.410407 10.822764 6.743414 12.487805-0.499512 3.663089-2.497561 5.74439-5.994146 6.243903-3.330081 0.499512-5.244878 0.582764-5.74439 0.249756v5.74439h60.440975v-5.74439c-4.49561-2.331057-7.076423-4.162602-7.742439-5.494634l-36.963902-59.941464 25.225366-32.718049c3.496585-4.162602 7.159675-6.993171 10.989268-8.491707 3.996098-1.498537 6.243902-2.247805 6.743415-2.247805v-5.74439h-41.959025v5.74439c6.660163 0.83252 10.65626 2.081301 11.988293 3.746342 1.498537 1.498537 2.164553 2.331057 1.998049 2.497561-0.999024 4.162602-4.412358 9.906992-10.24 17.23317-5.661138 7.159675-8.907967 11.07252-9.740488 11.738537-7.659187-9.82374-12.571057-17.233171-14.73561-22.228293-2.164553-4.995122-3.080325-7.575935-2.747317-7.742439 0.499512-1.998049 2.414309-3.330081 5.74439-3.996097 3.496585-0.83252 5.494634-1.24878 5.994147-1.248781v-5.74439h-62.439025v5.74439c3.829593 0.999024 6.826667 2.997073 8.99122 5.994147 2.331057 2.830569 3.579837 4.412358 3.746341 4.745365l31.968781 52.199025c-18.481951 25.308618-30.553496 39.627967-36.214634 42.958049-5.661138 3.330081-8.158699 4.329106-7.492683 2.997073v5.74439h41.959024v-5.74439c-6.493659 0.166504-10.323252-0.915772-11.48878-3.246829-1.165528-2.331057-1.581789-3.746341-1.248781-4.245854 0.83252-3.496585 4.162602-9.324228 9.990244-17.482927 5.994146-8.158699 9.490732-12.737561 10.489756-13.736585zM668.04761 609.970992c14.818862-0.999024 26.557398-6.16065 35.21561-15.484878v14.485853c5.827642-0.999024 13.320325-1.998049 22.478048-2.997073 9.324228-0.999024 14.485854-1.581789 15.484878-1.748292 6.993171-0.333008 10.573008-0.666016 10.739513-0.999025v-6.493658c-7.492683-0.166504-11.905041-2.497561-13.237074-6.993171-1.332033-4.49561-1.831545-7.159675-1.498536-7.992195v-91.660488h-49.701464v5.74439c0.333008 0.83252 0.666016 1.165528 0.999025 0.999025 6.993171 1.165528 11.239024 3.829593 12.737561 7.992195 1.498537 3.996098 2.164553 6.243902 1.998049 6.743414v72.179513c-6.327154 6.993171-13.153821 10.573008-20.48 10.739512-10.822764-1.332033-15.734634-7.409431-14.73561-18.232195v-86.165854h-46.70439v5.74439c6.493659 1.665041 10.24 4.578862 11.239024 8.741464 1.165528 4.162602 1.581789 6.493659 1.24878 6.99317v63.687805c0.333008 12.987317 3.996098 22.145041 10.989269 27.473171 7.159675 5.161626 14.902114 7.575935 23.227317 7.242927z" p-id="3226"></path><path d="M802.79935 765.127805a261.020098 261.020098 0 0 0 27.106861-5.32813 261.527935 261.527935 0 0 0-27.115187-5.419708 553.984 553.984 0 0 0-27.106861-3.255154c-9.032846-0.907447-20.513301-1.448585-30.811578-1.898146a654.302699 654.302699 0 0 0 18.523578-16.983415 428.265106 428.265106 0 0 0 34.791024-36.148032 441.344 441.344 0 0 0-41.934049 27.106861 691.641236 691.641236 0 0 0-24.309593 18.615155c0-9.032846-0.990699-18.065691-1.981399-27.106862a315.708358 315.708358 0 0 0-3.163577-22.594602 199.704976 199.704976 0 0 0-5.32813-22.594601c-2.231154 7.409431-3.979447 14.96039-5.244878 22.594601-1.357008 7.501008-2.347707 15.002016-3.163577 22.594602a390.576911 390.576911 0 0 0-1.989724 27.106862 822.25535 822.25535 0 0 0-24.309593-18.615155 465.545366 465.545366 0 0 0-41.925724-27.106861 456.820553 456.820553 0 0 0 34.699447 36.139707 276.563252 276.563252 0 0 0 18.706732 17.083317c-10.306602 0-20.696455 0.999024-30.994732 1.898146-10.306602 0.899122-18.074016 1.806569-27.115187 3.163577-9.124423 1.332033-18.173919 3.138602-27.106862 5.419708 9.041171 2.347707 18.074016 3.88787 27.106862 5.32813a395.28065 395.28065 0 0 0 27.115187 3.163577c9.032846 0.81587 20.68813 1.540163 30.994732 1.898146-6.327154 5.602862-12.562732 11.297301-18.706732 17.083318a456.770602 456.770602 0 0 0-34.699447 36.148032 465.545366 465.545366 0 0 0 41.925724-27.115187c8.225301-6.052423 16.267447-12.196423 24.309593-18.065691 0.366309 9.091122 0.999024 18.123967 1.898147 27.106862a257.998049 257.998049 0 0 0 8.491707 45.180878c4.220878-14.768911 7.059772-29.88748 8.491707-45.180878 0.999024-9.041171 1.63174-18.074016 1.998049-27.115187 7.950569 6.327154 16.084293 12.571057 24.309593 18.074016a441.377301 441.377301 0 0 0 41.925724 27.115187 442.259772 442.259772 0 0 0-34.79935-36.148032 654.327675 654.327675 0 0 0-18.515252-16.983415c10.298276 0 20.513301-0.999024 30.811578-1.906472a414.178862 414.178862 0 0 0 27.106861-3.246829" p-id="3227"></path><path d="M979.543415 412.796878c31.177886-63.254894 32.176911-150.636228-37.588293-190.580553-64.245593-36.780748-154.615675-36.148033-250.67187-15.992715C628.569496 217.729041 533.204293 251.004878 405.187642 306.076098c73.494894-36.930602 133.353106-64.337171 179.557984-82.228033a644.212553 644.212553 0 0 1 249.589594-48.261203c124.70322 3.613138 230.524878 76.358764 168.801821 228.535154-37.172033 91.993496-118.351089 192.986537-243.537171 302.995773 109.101789-110.059187 182.413528-208.171707 219.95187-294.320911z" p-id="3228"></path></svg>`;
};

export default function () {
  return async function (ctx: Context, next: Next) {
    await next();

    const fileName = ctx.path.split("/").slice(-1)[0];

    if (ctx.status !== 404 && ctx.path.startsWith("/image") && /^\d+\..+$/.test(fileName)) {
      // 水印信息
      const watermark = {
        text: COPYRIGHT,
        width: 30,
        height: 30
      };

      // 原图尺寸
      const originSize = imageSize(`${ASSET_DIR}${ctx.path}`);
      if (originSize.width && originSize.height) {
        // 水印位置
        const offset = Math.floor(Math.min(originSize.width, originSize.height) * 0.02);
        watermark.width = originSize.width * 0.1;
        watermark.height = originSize.width * 0.1;

        const imageBuffer = await sharp(`${ASSET_DIR}${ctx.path}`, { animated: true })
          .composite([
            // SVG 水印
            {
              input: Buffer.from(generateSVG(watermark.width, watermark.height)),
              blend: "dest-out",
              top: offset,
              left: Math.floor(originSize.width - watermark.width - offset)
            },
            // 版权文字水印
            {
              input: {
                text: {
                  text: watermark.text,
                  width: originSize.width,
                  height: originSize.height * 0.02,
                  rgba: true
                }
              },
              blend: "xor",
              top: Math.floor(originSize.height - originSize.height * 0.02 - offset / 2),
              left: Math.floor(offset / 2)
            }
          ])
          .withMetadata()
          .toBuffer();

        ctx.body = stream.Readable.from([imageBuffer]);
      }
    }
  };
}
